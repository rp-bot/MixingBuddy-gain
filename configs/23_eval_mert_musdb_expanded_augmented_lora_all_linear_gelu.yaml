# @package _global_

# Evaluation config for MERT + multi-anchor training with augmented data and LoRA on all linear layers (experiment 23)
# This evaluates the model trained with MERT encoder, multi-anchor MUSDB data (augmented no-error class), and LoRA on all linear layers
defaults:
  - data: 08_musdb_expanded_augmented_variations
  - model: qwen2_7b_mert_musdb_expanded_lora_all_linear
  - evaluation: evaluation
  - training: training # Include training config for trainer compatibility
  - experiment_tracking: wandb
  - experiment_naming: experiment_naming
  - plotting: plotting
  - _self_

model:
  config_name: "qwen2_7b_mert_musdb_expanded_lora_all_linear_gelu"
  projection:
    activation: "gelu"
# Environment settings
env:
  seed: 42
  project_name: "automatic-mixing-milestone-0"
  # Output directory will be determined by checkpoint run name

# Model checkpoint settings
# Set this to the path of your trained MERT + multi-anchor model checkpoint
# Options:
# - null: Use base model (no trained weights)
# - "latest": Automatically use the latest checkpoint
# - "path/to/checkpoint": Use specific checkpoint
checkpoint_path: "outputs/checkpoints/mixing_buddy_milestone_0/qlora-qwen2-7b-mert-musdb-expanded-lora-all-linear-gelu-r16a32-musdb/checkpoint-4600" # Update this to the trained MERT + multi-anchor augmented LoRA all linear checkpoint path

# IMPORTANT: The evaluation output directory will be automatically determined
# from the checkpoint path. For example, if checkpoint is:
# "outputs/checkpoints/mixing_buddy_milestone_0/qlora-qwen2-7b-mert-musdb-expanded-augmented-lora-all-linear-XXXX-XXXX/checkpoint-XXX"
# Then evaluation will be saved to:
# "outputs/evaluation/qlora-qwen2-7b-mert-musdb-expanded-augmented-lora-all-linear-XXXX-XXXX/predictions/"

# Predictions file path for metrics computation
# If not specified, the script will use the new evaluation structure
# predictions_path: "outputs/evaluation/qlora-qwen2-7b-mert-musdb-expanded-augmented-lora-all-linear-XXXX-XXXX/predictions/predictions.jsonl"

# Plotting configuration
plotting:
  # These will be automatically set based on checkpoint path
  metrics_file: null # Will be set to {output_dir}/predictions/metrics_results_detailed.json
  output_dir: null # Will be set to {output_dir}/predictions/

# Experiment tracking settings
experiment_tracking:
  use_wandb: false
  use_mlflow: false

# Evaluation-specific overrides for MERT + multi-anchor model
evaluation:
  # Use the trained MERT projection weights
  use_random_projection: false # Use the trained projection weights

  # Generation samples for evaluation
  num_generation_samples: 10000 # Multiple samples for better statistical significance

  # Partial ground truth settings
  use_partial_ground_truth: false
  num_prefix_tokens: 3

  # Instruction modification settings
  add_first_sentence_to_instruction: false  # If true, append first sentence of ground truth to instruction

  # Memory settings - MERT should be memory efficient
  memory:
    max_memory_usage_gb: 8.0 # MERT is efficient but still needs some headroom

  decode_audio_embeddings:
    enabled: false
    top_k: 3
    max_samples: 5
    max_audio_tokens: null
